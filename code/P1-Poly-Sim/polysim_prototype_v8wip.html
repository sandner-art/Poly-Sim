        function initializeSimulation() {
            const dimensions = calculateOptimalDimensions();
            width = dimensions.width;
            height = dimensions.height;
            
            // Initialize fields
            conductivityField = new Float32Array(width * height);
            tempField = new Float32Array(width * height);
            firingField = new Float32Array(width * height);
            
            // Initialize agents
            agents = [];
            const centerX = width * 0.5;
            const centerY = height * 0.5;
            const radius = Math.min(width, height) * 0.3;
            
            for (let i = 0; i < params.agentCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = Math.random() * radius;
                const x = centerX + Math.cos(angle) * r;
                const y = centerY + Math.sin(angle) * r;
                agents.push(new Agent(x, y, angle));
            }
            
            // Initialize GPU textures if using GPU
            if (useGPU && gpuSupported) {
                initGPUTextures();
            }
            
            updateViewTransform();
        }
        
        function initGPUTextures() {
            if (!gl || !useGPU) return;
            
            // Calculate agent texture dimensions
            const agentCount = params.agentCount;
            const agentTexSize = Math.ceil(Math.sqrt(agentCount));
            
            // Create agent data texture
            const agentData = new Float32Array(agentTexSize * agentTexSize * 4);
            for (let i = 0; i < agents.length; i++) {
                const agent = agents[i];
                const texIndex = i * 4;
                agentData[texIndex] = agent.x;
                agentData[texIndex + 1] = agent.y;
                agentData[texIndex + 2] = agent.angle;
                agentData[texIndex + 3] = 1.0;
            }
            
            agentTexture = createTexture(gl, agentTexSize, agentTexSize, gl.RGBA32F, gl.FLOAT, agentData);
            newAgentTexture = createTexture(gl, agentTexSize, agentTexSize, gl.RGBA32F, gl.FLOAT, null);
            
            // Create conductivity textures
            const condData = new Float32Array(width * height);
            for (let i = 0; i < conductivityField.length; i++) {
                condData[i] = conductivityField[i];
            }
            
            conductivityTexture = createTexture(gl, width, height, gl.R32F, gl.FLOAT, condData);
            newConductivityTexture = createTexture(gl, width, height, gl.R32F, gl.FLOAT, null);
            
            // Create mask texture
            if (hasMask) {
                maskTexture = createTexture(gl, width, height, gl.R32F, gl.FLOAT, maskField);
            }
        }
        
        function updateSimulation() {
            if (isPaused) return;
            
            if (useGPU && gpuSupported) {
                updateSimulationGPU();
            } else {
                updateSimulationCPU();
            }
            
            // Update firing field decay
            if (params.neuronFiring) {
                for (let i = 0; i < firingField.length; i++) {
                    firingField[i] *= 0.95; // Firing decay
                }
            }
        }
        
        function updateSimulationCPU() {
            // Update agents
            for (let agent of agents) {
                agent.update();
            }
            
            // Apply decay and diffusion
            for (let i = 0; i < conductivityField.length; i++) {
                conductivityField[i] *= params.decayRate;
            }
            
            applyDiffusion();
        }
        
        function updateSimulationGPU() {
            if (!gl || !useGPU || isPaused) return;
            
            const agentTexSize = Math.ceil(Math.sqrt(params.agentCount));
            
            // Update agents
            gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, newAgentTexture, 0);
            gl.viewport(0, 0, agentTexSize, agentTexSize);
            
            gl.useProgram(agentUpdateProgram);
            gl.bindVertexArray(quadVAO);
            
            // Bind textures
            gl.activeTexture(gl.TEXTURE0);
            gl.bindTexture(gl.TEXTURE_2D, agentTexture);
            gl.uniform1i(gl.getUniformLocation(agentUpdateProgram, 'u_agentData'), 0);
            
            gl.activeTexture(gl.TEXTURE1);
            gl.bindTexture(gl.TEXTURE_2D, conductivityTexture);
            gl.uniform1i(gl.getUniformLocation(agentUpdateProgram, 'u_conductivity'), 1);
            
            if (hasMask && maskTexture) {
                gl.activeTexture(gl.TEXTURE2);
                gl.bindTexture(gl.TEXTURE_2D, maskTexture);
                gl.uniform1i(gl.getUniformLocation(agentUpdateProgram, 'u_mask'), 2);
            }
            
            // Set uniforms
            gl.uniform2f(gl.getUniformLocation(agentUpdateProgram, 'u_resolution'), width, height);
            gl.uniform1f(gl.getUniformLocation(agentUpdateProgram, 'u_sensorAngle'), params.sensorAngle);
            gl.uniform1f(gl.getUniformLocation(agentUpdateProgram, 'u_sensorDistance'), params.sensorDistance);
            gl.uniform1f(gl.getUniformLocation(agentUpdateProgram, 'u_stepSize'), params.stepSize);
            gl.uniform1f(gl.getUniformLocation(agentUpdateProgram, 'u_speed'), params.speed);
            gl.uniform1f(gl.getUniformLocation(agentUpdateProgram, 'u_time'), performance.now() / 1000);
            gl.uniform1i(gl.getUniformLocation(agentUpdateProgram, 'u_hasMask'), hasMask);
            
            gl.drawArrays(gl.TRIANGLES, 0, 6);
            
            // Update conductivity
            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, newConductivityTexture, 0);
            gl.viewport(0, 0, width, height);
            
            gl.useProgram(conductivityUpdateProgram);
            
            gl.activeTexture(gl.TEXTURE0);
            gl.bindTexture(gl.TEXTURE_2D, conductivityTexture);
            gl.uniform1i(gl.getUniformLocation(conductivityUpdateProgram, 'u_conductivity'), 0);
            
            gl.activeTexture(gl.TEXTURE1);
            gl.bindTexture(gl.TEXTURE_2D, newAgentTexture);
            gl.uniform1i(gl.getUniformLocation(conductivityUpdateProgram, 'u_agentData'), 1);
            
            gl.uniform2f(gl.getUniformLocation(conductivityUpdateProgram, 'u_resolution'), width, height);
            gl.uniform2f(gl.getUniformLocation(conductivityUpdateProg<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Poly-Sim: Self-Organizing Networks</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        canvas {
            display: block;
            cursor: crosshair;
            touch-action: none;
        }
        
        .ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            padding: 20px;
            border-radius: 15px;
            color: white;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
            pointer-events: auto;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .controls.collapsed {
            transform: translateY(calc(100% - 60px));
        }
        
        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }
        
        .controls-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .controls-header h3 {
            margin: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .gpu-indicator {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .gpu-indicator.gpu-on {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #4CAF50;
        }
        
        .gpu-indicator.gpu-off {
            background: rgba(255, 152, 0, 0.3);
            border: 1px solid rgba(255, 152, 0, 0.5);
            color: #FF9800;
        }
        
        .toggle-btn {
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .controls-content {
            transition: opacity 0.3s ease, max-height 0.3s ease;
            overflow: hidden;
        }
        
        .controls.collapsed .controls-content {
            opacity: 0;
            max-height: 0;
        }
        
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .section-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .preset-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .preset-btn {
            padding: 10px 8px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
        
        .preset-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(100, 200, 255, 0.4);
        }
        
        .preset-btn.physarum.active {
            background: rgba(100, 255, 100, 0.2);
            border-color: rgba(100, 255, 100, 0.4);
        }
        
        .preset-btn.plasma.active {
            background: rgba(100, 150, 255, 0.2);
            border-color: rgba(100, 150, 255, 0.4);
        }
        
        .preset-btn.neural.active {
            background: rgba(0, 255, 255, 0.2);
            border-color: rgba(0, 255, 255, 0.4);
        }
        
        .preset-btn.scientific.active {
            background: rgba(255, 165, 0, 0.2);
            border-color: rgba(255, 165, 0, 0.4);
        }
        
        .color-mode-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .color-mode-btn {
            padding: 6px 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 10px;
        }
        
        .color-mode-btn.active {
            background: rgba(255, 165, 0, 0.3);
            border-color: rgba(255, 165, 0, 0.5);
        }
        
        .control-group {
            margin-bottom: 12px;
        }
        
        .control-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 11px;
            opacity: 0.9;
        }
        
        .slider {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .checkbox-group label {
            font-size: 11px;
            margin: 0;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .button-grid.three-col {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .action-btn {
            padding: 10px 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .reset-btn {
            background: rgba(255, 100, 100, 0.2);
            border-color: rgba(255, 100, 100, 0.4);
        }
        
        .pause-btn {
            background: rgba(255, 200, 100, 0.2);
            border-color: rgba(255, 200, 100, 0.4);
        }
        
        .maze-btn {
            background: rgba(150, 100, 255, 0.2);
            border-color: rgba(150, 100, 255, 0.4);
        }
        
        .file-input-wrapper {
            position: relative;
            margin-bottom: 8px;
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-display {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            font-size: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-input-display:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-size: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: auto;
            transition: opacity 0.3s ease;
        }
        
        .info-panel.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .fps-counter {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
            pointer-events: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .version-info {
            text-align: center;
            padding: 12px;
            font-size: 10px;
            opacity: 0.6;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 15px;
        }
        
        .version-info a {
            color: #64B5F6;
            text-decoration: none;
        }
        
        .version-info a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 600px) {
            .controls {
                left: 10px;
                right: 10px;
                bottom: 10px;
                padding: 15px;
            }
            
            .info-panel {
                left: 10px;
                right: 10px;
                top: 10px;
            }
            
            .preset-selector {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .color-mode-selector {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (orientation: landscape) and (max-height: 500px) {
            .controls {
                max-height: 80vh;
                left: 10px;
                right: 300px;
            }
            
            .fps-counter {
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div class="ui-overlay">
        <div class="controls" id="controls">
            <div class="controls-header" onclick="toggleControls()">
                <h3>
                    Poly-Sim 
                    <span class="gpu-indicator" id="gpuIndicator">CPU</span>
                </h3>
                <div class="toggle-btn" id="toggleBtn">▲</div>
            </div>
            
            <div class="controls-content">
                <!-- Simulation Presets -->
                <div class="section">
                    <div class="section-title">🧬 Simulation Mode</div>
                    <div class="preset-selector">
                        <div class="preset-btn physarum active" data-preset="physarum">Physarum</div>
                        <div class="preset-btn plasma" data-preset="plasma">Plasma</div>
                        <div class="preset-btn neural" data-preset="neural">Neural</div>
                        <div class="preset-btn scientific" data-preset="scientific">Scientific</div>
                    </div>
                    <div class="color-mode-selector">
                        <div class="color-mode-btn active" data-mode="natural">Natural</div>
                        <div class="color-mode-btn" data-mode="scientific">Analysis</div>
                        <div class="color-mode-btn" data-mode="thermal">Thermal</div>
                        <div class="color-mode-btn" data-mode="neon">Neon</div>
                    </div>
                </div>
                
                <!-- Environment Controls -->
                <div class="section">
                    <div class="section-title">🌍 Environment</div>
                    <div class="file-input-wrapper">
                        <input type="file" class="file-input" id="maskInput" accept="image/*">
                        <div class="file-input-display">Load Environment Mask</div>
                    </div>
                    <div class="button-grid three-col">
                        <div class="action-btn maze-btn" onclick="generateMaze()">Gen Maze</div>
                        <div class="action-btn maze-btn" onclick="clearMask()">Clear</div>
                        <div class="action-btn maze-btn" onclick="invertMask()">Invert</div>
                    </div>
                </div>
                
                <!-- Performance Settings -->
                <div class="section">
                    <div class="section-title">⚡ Performance</div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="gpuToggle">
                        <label for="gpuToggle">GPU Acceleration <span id="gpuStatus">(Checking...)</span></label>
                    </div>
                    <div class="control-group">
                        <label>Agent Count <span id="agentCountValue">50000</span></label>
                        <input type="range" class="slider" id="agentCount" min="5000" max="100000" value="50000" step="5000">
                    </div>
                </div>
                
                <!-- Simulation Parameters -->
                <div class="section">
                    <div class="section-title">🔬 Parameters</div>
                    <div class="control-group">
                        <label>Sensor Angle <span id="sensorAngleValue">22.5°</span></label>
                        <input type="range" class="slider" id="sensorAngle" min="5" max="90" value="22.5" step="2.5">
                    </div>
                    <div class="control-group">
                        <label>Decay Rate <span id="decayRateValue">0.980</span></label>
                        <input type="range" class="slider" id="decayRate" min="0.900" max="0.999" value="0.980" step="0.001">
                    </div>
                    <div class="control-group">
                        <label>Deposit Strength <span id="depositStrengthValue">0.10</span></label>
                        <input type="range" class="slider" id="depositStrength" min="0.01" max="0.5" value="0.10" step="0.01">
                    </div>
                    <div class="control-group">
                        <label>Speed <span id="speedValue">1.0</span></label>
                        <input type="range" class="slider" id="speed" min="0.1" max="5.0" value="1.0" step="0.1">
                    </div>
                </div>
                
                <!-- Advanced Features -->
                <div class="section">
                    <div class="section-title">🧠 Neural Features</div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="neuronFiring">
                        <label for="neuronFiring">Simulate Neuron Firing</label>
                    </div>
                    <div class="control-group">
                        <label>Firing Rate <span id="firingRateValue">0.02</span></label>
                        <input type="range" class="slider" id="firingRate" min="0.001" max="0.1" value="0.02" step="0.001">
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="button-grid">
                    <div class="action-btn reset-btn" onclick="resetSimulation()">Reset</div>
                    <div class="action-btn pause-btn" onclick="togglePause()">Pause</div>
                </div>
                
                <!-- Version Info -->
                <div class="version-info">
                    <a href="https://github.io/sandner-art/Poly-Sim" target="_blank">Poly-Sim</a> v0.7.0<br>
                    © Daniel Sandner • <a href="https://sandner.art" target="_blank">sandner.art</a>
                </div>
            </div>
        </div>
        
        <div class="fps-counter" id="fpsCounter">60 FPS</div>
        
        <div class="info-panel" id="infoPanel">
            <strong>🎨 Touch and drag to spawn agents</strong><br>
            Each preset simulates flow-reinforced conductivity principles<br>
            <small>Tap here to hide • Tap controls to collapse</small>
        </div>
    </div>

    <script>
        // Global variables
        let canvas, gl, ctx;
        let width, height;
        let animationId;
        let isPaused = false;
        let useGPU = false;
        let currentColorMode = 'natural';
        let simulationScale = 1.0;
        
        // Simulation state
        let agents = [];
        let conductivityField = [];
        let tempField = [];
        let maskField = [];
        let firingField = [];
        let hasMask = false;
        
        // GPU resources
        let gpuSupported = false;
        let agentTexture, newAgentTexture;
        let conductivityTexture, newConductivityTexture;
        let maskTexture;
        let agentUpdateProgram, conductivityUpdateProgram, renderProgram;
        let quadVAO, quadVBO;
        let framebuffer;
        
        // Performance tracking
        let frameCount = 0;
        let lastTime = 0;
        let fps = 60;
        
        // Touch/mouse coordinate mapping
        let viewTransform = {
            offsetX: 0,
            offsetY: 0,
            scaleX: 1,
            scaleY: 1
        };
        
        // Simulation parameters
        let params = {
            agentCount: 50000,
            sensorAngle: 22.5 * Math.PI / 180,
            sensorDistance: 9.0,
            stepSize: 1.0,
            decayRate: 0.980,
            depositStrength: 0.10,
            speed: 1.0,
            diffusionRate: 0.1,
            neuronFiring: false,
            firingRate: 0.02
        };
        
        // Color palettes
        const colorModes = {
            natural: {
                physarum: {
                    color1: [0.05, 0.02, 0.0],
                    color2: [0.4, 0.8, 0.2],
                    color3: [0.9, 0.9, 0.4]
                },
                plasma: {
                    color1: [0.0, 0.0, 0.1],
                    color2: [0.3, 0.1, 0.8],
                    color3: [0.9, 0.7, 1.0]
                },
                neural: {
                    color1: [0.0, 0.05, 0.1],
                    color2: [0.0, 0.4, 0.8],
                    color3: [0.3, 0.8, 1.0]
                },
                scientific: {
                    color1: [0.1, 0.1, 0.1],
                    color2: [0.8, 0.4, 0.0],
                    color3: [1.0, 0.8, 0.2]
                }
            },
            scientific: {
                physarum: {
                    color1: [0.0, 0.0, 0.2],
                    color2: [0.0, 0.8, 0.8],
                    color3: [1.0, 1.0, 0.0]
                },
                plasma: {
                    color1: [0.2, 0.0, 0.0],
                    color2: [0.8, 0.0, 0.8],
                    color3: [1.0, 0.5, 0.0]
                },
                neural: {
                    color1: [0.0, 0.0, 0.0],
                    color2: [0.0, 1.0, 0.0],
                    color3: [1.0, 0.0, 0.0]
                },
                scientific: {
                    color1: [0.0, 0.0, 0.0],
                    color2: [0.5, 0.5, 0.5],
                    color3: [1.0, 1.0, 1.0]
                }
            },
            thermal: {
                physarum: {
                    color1: [0.0, 0.0, 0.2],
                    color2: [0.8, 0.0, 0.0],
                    color3: [1.0, 1.0, 0.0]
                },
                plasma: {
                    color1: [0.0, 0.0, 0.0],
                    color2: [0.5, 0.0, 0.5],
                    color3: [1.0, 0.0, 1.0]
                },
                neural: {
                    color1: [0.0, 0.0, 0.4],
                    color2: [0.0, 0.5, 1.0],
                    color3: [1.0, 1.0, 1.0]
                },
                scientific: {
                    color1: [0.0, 0.0, 0.5],
                    color2: [1.0, 0.5, 0.0],
                    color3: [1.0, 1.0, 0.5]
                }
            },
            neon: {
                physarum: {
                    color1: [0.1, 0.0, 0.1],
                    color2: [0.0, 1.0, 0.5],
                    color3: [0.5, 1.0, 1.0]
                },
                plasma: {
                    color1: [0.1, 0.0, 0.2],
                    color2: [1.0, 0.0, 1.0],
                    color3: [0.0, 1.0, 1.0]
                },
                neural: {
                    color1: [0.0, 0.1, 0.2],
                    color2: [0.0, 1.0, 0.0],
                    color3: [1.0, 1.0, 0.0]
                },
                scientific: {
                    color1: [0.2, 0.0, 0.2],
                    color2: [1.0, 0.0, 0.0],
                    color3: [0.0, 0.0, 1.0]
                }
            }
        };
        
        // Presets
        const presets = {
            physarum: {
                agentCount: 50000,
                sensorAngle: 22.5 * Math.PI / 180,
                decayRate: 0.980,
                depositStrength: 0.10,
                speed: 1.0,
                diffusionRate: 0.3
            },
            plasma: {
                agentCount: 80000,
                sensorAngle: 45 * Math.PI / 180,
                decayRate: 0.950,
                depositStrength: 0.20,
                speed: 2.5,
                diffusionRate: 0.1
            },
            neural: {
                agentCount: 30000,
                sensorAngle: 30 * Math.PI / 180,
                decayRate: 0.995,
                depositStrength: 0.05,
                speed: 0.8,
                diffusionRate: 0.05
            },
            scientific: {
                agentCount: 60000,
                sensorAngle: 35 * Math.PI / 180,
                decayRate: 0.985,
                depositStrength: 0.15,
                speed: 1.2,
                diffusionRate: 0.2
            }
        };
        
        let currentPreset = 'physarum';
        
        // Agent class
        class Agent {
            constructor(x, y, angle) {
                this.x = x || Math.random() * width;
                this.y = y || Math.random() * height;
                this.angle = angle || Math.random() * Math.PI * 2;
                this.dx = Math.cos(this.angle);
                this.dy = Math.sin(this.angle);
            }
            
            update() {
                // Sample conductivity at sensor positions
                const sensorDist = params.sensorDistance;
                const sensorAngle = params.sensorAngle;
                
                const leftAngle = this.angle - sensorAngle;
                const rightAngle = this.angle + sensorAngle;
                
                const leftX = this.x + Math.cos(leftAngle) * sensorDist;
                const leftY = this.y + Math.sin(leftAngle) * sensorDist;
                const rightX = this.x + Math.cos(rightAngle) * sensorDist;
                const rightY = this.y + Math.sin(rightAngle) * sensorDist;
                const centerX = this.x + Math.cos(this.angle) * sensorDist;
                const centerY = this.y + Math.sin(this.angle) * sensorDist;
                
                const leftVal = sampleConductivity(leftX, leftY);
                const rightVal = sampleConductivity(rightX, rightY);
                const centerVal = sampleConductivity(centerX, centerY);
                
                // Check mask collision
                if (hasMask && !canMoveTo(this.x, this.y)) {
                    this.angle += (Math.random() - 0.5) * Math.PI;
                    this.dx = Math.cos(this.angle);
                    this.dy = Math.sin(this.angle);
                    return;
                }
                
                // Determine steering direction
                let steerAngle = 0;
                if (centerVal > leftVal && centerVal > rightVal) {
                    steerAngle = 0;
                } else if (leftVal > rightVal) {
                    steerAngle = -sensorAngle * 0.1;
                } else if (rightVal > leftVal) {
                    steerAngle = sensorAngle * 0.1;
                } else {
                    steerAngle = (Math.random() - 0.5) * sensorAngle * 0.2;
                }
                
                // Apply steering
                this.angle += steerAngle;
                this.dx = Math.cos(this.angle);
                this.dy = Math.sin(this.angle);
                
                // Move agent
                const newX = this.x + this.dx * params.stepSize * params.speed;
                const newY = this.y + this.dy * params.stepSize * params.speed;
                
                // Check if new position is valid
                if (!hasMask || canMoveTo(newX, newY)) {
                